<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Portal ‚Äì Farmer Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(to bottom right, #a5d956, #4da2ca);
      font-family: 'Poppins', sans-serif;
    }
    .card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      padding: 2rem;
    }
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 8px 10px;
      text-align: left;
    }
    th {
      background: #f3f4f6;
    }
    .modal {
      position: fixed; inset: 0;
      display: none; 
      justify-content: center; align-items: center;
      background: rgba(0,0,0,0.5);
    }
    .modal-content {
      background: white; padding: 2rem; border-radius: 1rem;
      width: 400px; max-width: 95%;
    }
  </style>
</head>
<body class="min-h-screen p-6">

  <div class="card max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold text-blue-600 text-center mb-6">üë®‚Äçüíº Admin Dashboard</h1>

    <div class="flex justify-between mb-4">
      <div class="space-x-2">
        <button id="refreshBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">üîÑ Refresh Data</button>
        <button id="openAddModal" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">‚ûï Add User</button>
      </div>
      <button onclick="window.location.href='index.html'" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">‚¨Ö Back to Login</button>
    </div>

    <div class="overflow-x-auto">
      <table id="usersTable" class="w-full">
        <thead>
          <tr>
            <th>Name</th>
            <th>Phone</th>
            <th>Farm Size</th>
            <th>Location</th>
            <th>Wheat Points</th>
            <th>Rice Points</th>
            <th>Corn Points</th>
            <th>Bajra Points</th>
            <th>Tasks Completed</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="usersBody">
          <tr><td colspan="10" class="text-center p-4">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <h2 class="text-xl font-bold mb-4 text-blue-600">‚úèÔ∏è Edit User</h2>
      <form id="editForm" class="space-y-3">
        <input type="hidden" id="editId">
        <input type="text" id="editName" class="w-full border p-2 rounded" placeholder="Name" required>
        <input type="text" id="editPhone" class="w-full border p-2 rounded" placeholder="Phone" required>
        <input type="text" id="editFarmSize" class="w-full border p-2 rounded" placeholder="Farm Size">
        <input type="text" id="editLocation" class="w-full border p-2 rounded" placeholder="Location">
        <input type="number" id="editWheat" class="w-full border p-2 rounded" placeholder="Wheat Points">
        <input type="number" id="editRice" class="w-full border p-2 rounded" placeholder="Rice Points">
        <input type="number" id="editCorn" class="w-full border p-2 rounded" placeholder="Corn Points">
        <input type="number" id="editBajra" class="w-full border p-2 rounded" placeholder="Bajra Points">
        <div class="flex justify-end space-x-2">
          <button type="button" id="closeModal" class="bg-gray-400 px-3 py-1 rounded text-white">Cancel</button>
          <button type="submit" class="bg-blue-500 px-3 py-1 rounded text-white">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add User Modal -->
  <div id="addModal" class="modal">
    <div class="modal-content">
      <h2 class="text-xl font-bold mb-4 text-green-600">‚ûï Add User</h2>
      <form id="addForm" class="space-y-3">
        <input type="text" id="addName" class="w-full border p-2 rounded" placeholder="Name" required>
        <input type="text" id="addPhone" class="w-full border p-2 rounded" placeholder="Phone" required>
        <input type="password" id="addPassword" class="w-full border p-2 rounded" placeholder="Password" required>
        <input type="text" id="addFarmSize" class="w-full border p-2 rounded" placeholder="Farm Size">
        <input type="text" id="addLocation" class="w-full border p-2 rounded" placeholder="Location">
        <input type="number" id="addWheat" class="w-full border p-2 rounded" placeholder="Wheat Points">
        <input type="number" id="addRice" class="w-full border p-2 rounded" placeholder="Rice Points">
        <input type="number" id="addCorn" class="w-full border p-2 rounded" placeholder="Corn Points">
        <input type="number" id="addBajra" class="w-full border p-2 rounded" placeholder="Bajra Points">
        <div class="flex justify-end space-x-2">
          <button type="button" id="closeAddModal" class="bg-gray-400 px-3 py-1 rounded text-white">Cancel</button>
          <button type="submit" class="bg-green-500 px-3 py-1 rounded text-white">Add</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API = 'http://localhost:3000/api/admin/users';
    const usersBody = document.getElementById('usersBody');
    const refreshBtn = document.getElementById('refreshBtn');

    const editModal = document.getElementById('editModal');
    const closeModal = document.getElementById('closeModal');
    const editForm = document.getElementById('editForm');

    const addModal = document.getElementById('addModal');
    const openAddModal = document.getElementById('openAddModal');
    const closeAddModal = document.getElementById('closeAddModal');
    const addForm = document.getElementById('addForm');

    // Load Users
    async function loadUsers() {
      usersBody.innerHTML = `<tr><td colspan="10" class="text-center p-4">‚è≥ Loading...</td></tr>`;
      try {
        const res = await fetch(API);
        const data = await res.json();

        if (!Array.isArray(data)) throw new Error(data.message || "Error fetching users");

        usersBody.innerHTML = "";
        data.forEach(user => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${user.name}</td>
            <td>${user.phoneNo}</td>
            <td>${user.farmSize || 'N/A'}</td>
            <td>${user.location || 'N/A'}</td>
            <td class="text-green-600 font-bold">${user.pointsWheat}</td>
            <td class="text-green-600 font-bold">${user.pointsRice}</td>
            <td class="text-green-600 font-bold">${user.pointsCorn}</td>
            <td class="text-green-600 font-bold">${user.pointsBajra}</td>
            <td>
              Wheat: ${user.tasksCompletedWheat.length}<br>
              Rice: ${user.tasksCompletedRice.length}<br>
              Corn: ${user.tasksCompletedCorn.length}<br>
              Bajra: ${user.tasksCompletedBajra.length}
            </td>
            <td>
              <button class="bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded editBtn" data-user='${JSON.stringify(user)}'>Edit</button>
              <button class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded deleteBtn" data-id="${user._id}">Delete</button>
            </td>
          `;
          usersBody.appendChild(row);
        });

        // Attach edit & delete events
        document.querySelectorAll('.editBtn').forEach(btn => {
          btn.addEventListener('click', () => {
            const user = JSON.parse(btn.dataset.user);
            openEditModal(user);
          });
        });

        document.querySelectorAll('.deleteBtn').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = btn.dataset.id;
            deleteUser(id);
          });
        });

      } catch (err) {
        usersBody.innerHTML = `<tr><td colspan="10" class="text-center text-red-500 p-4">${err.message}</td></tr>`;
      }
    }

    refreshBtn.addEventListener('click', loadUsers);

    // Edit Modal
    function openEditModal(user) {
      document.getElementById('editId').value = user._id;
      document.getElementById('editName').value = user.name;
      document.getElementById('editPhone').value = user.phoneNo;
      document.getElementById('editFarmSize').value = user.farmSize || '';
      document.getElementById('editLocation').value = user.location || '';
      document.getElementById('editWheat').value = user.pointsWheat;
      document.getElementById('editRice').value = user.pointsRice;
      document.getElementById('editCorn').value = user.pointsCorn;
      document.getElementById('editBajra').value = user.pointsBajra;
      editModal.style.display = 'flex';
    }

    closeModal.addEventListener('click', () => { editModal.style.display = 'none'; });

    editForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('editId').value;
      const updated = {
        name: document.getElementById('editName').value,
        phoneNo: document.getElementById('editPhone').value,
        farmSize: document.getElementById('editFarmSize').value,
        location: document.getElementById('editLocation').value,
        pointsWheat: parseInt(document.getElementById('editWheat').value) || 0,
        pointsRice: parseInt(document.getElementById('editRice').value) || 0,
        pointsCorn: parseInt(document.getElementById('editCorn').value) || 0,
        pointsBajra: parseInt(document.getElementById('editBajra').value) || 0,
      };
      try {
        const res = await fetch(`${API}/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updated)
        });
        if (!res.ok) throw new Error("Update failed");
        editModal.style.display = 'none';
        loadUsers();
      } catch (err) {
        alert(err.message);
      }
    });

    // Delete User
    async function deleteUser(id) {
      if (!confirm("Are you sure you want to delete this user?")) return;
      try {
        const res = await fetch(`${API}/${id}`, { method: 'DELETE' });
        if (!res.ok) throw new Error("Delete failed");
        loadUsers();
      } catch (err) {
        alert(err.message);
      }
    }

    // Add User Modal
    openAddModal.addEventListener('click', () => { addModal.style.display = 'flex'; });
    closeAddModal.addEventListener('click', () => { addModal.style.display = 'none'; });

    addForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const newUser = {
        name: document.getElementById('addName').value,
        phoneNo: document.getElementById('addPhone').value,
        password: document.getElementById('addPassword').value,
        farmSize: document.getElementById('addFarmSize').value,
        location: document.getElementById('addLocation').value,
        pointsWheat: parseInt(document.getElementById('addWheat').value) || 0,
        pointsRice: parseInt(document.getElementById('addRice').value) || 0,
        pointsCorn: parseInt(document.getElementById('addCorn').value) || 0,
        pointsBajra: parseInt(document.getElementById('addBajra').value) || 0
      };
      try {
        const res = await fetch(API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(newUser)
        });
        if (!res.ok) {
          const errData = await res.json();
          throw new Error(errData.message || "Add user failed");
        }
        addModal.style.display = 'none';
        addForm.reset();
        loadUsers();
      } catch (err) {
        alert(err.message);
      }
    });

    loadUsers();
  </script>
</body>
</html>
