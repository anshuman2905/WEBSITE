<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>üåæ Rice Farming Season Simulator</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: 'Poppins', sans-serif; background: linear-gradient(to bottom, #e0f7fa, #ffffff); }
  .tooltip { position: relative; cursor: pointer; color: #065f46; }
  .tooltip:hover::after {
    content: attr(data-tip);
    position: absolute; left: 50%; transform: translateX(-50%);
    top: 30px; background: #065f46; color: #fff; padding: 6px 10px;
    border-radius: 5px; white-space: nowrap; z-index: 50; font-size: 0.85rem;
  }
  .progress { height: 18px; border-radius: 9px; overflow: hidden; background: #a7f3d0; margin-bottom: 20px; box-shadow: inset 0 0 5px rgba(0,0,0,0.1);}
  .progress-bar { height: 18px; background: #065f46; width: 0%; transition: width .4s ease; }
  .graph-container { margin-top: 25px; background:#ffffff; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1);}
  .card { background:#ffffff; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); margin-bottom:20px; }
  .btn { transition: all 0.3s ease; }
  .btn:hover { transform: translateY(-2px); }
</style>
</head>
<body class="p-6">

<div class="max-w-6xl mx-auto flex gap-6">
  <!-- Sidebar -->
  <div id="sidebar" class="w-64 bg-green-50 p-4 rounded-lg shadow-md sticky top-6 h-fit">
    <h2 class="font-bold text-xl mb-3 text-green-800">üìã Progress</h2>
    <p id="sidebarStep" class="mb-2 font-semibold">Step: 1Ô∏è‚É£</p>
    <p id="sidebarDecision" class="mb-2">Decision Score: 0</p>
    <p id="sidebarYield" class="mb-2">Yield Score: 0</p>
    <p id="sidebarHint" class="text-gray-700 text-sm">Hint will appear here.</p>
  </div>

  <!-- Main content -->
  <div class="flex-1">
    <h1 class="text-4xl font-extrabold text-green-800 mb-4 text-center">üåæ Rice Farming Season Simulator</h1>
    <p class="text-center mb-6 text-gray-700 text-lg">Simulate a full season of rice farming‚Äîmake decisions and see how your choices affect yield and score!</p>

    <div class="progress"><div class="progress-bar" id="progressBar"></div></div>

    <div id="taskContainer" class="card"></div>

    <div id="predictedPreview" class="card hidden bg-yellow-50">
      <p id="yieldPreviewText" class="font-semibold text-yellow-800"></p>
      <p id="alertText" class="text-red-600 font-semibold"></p>
    </div>

    <div id="reportCard" class="card hidden bg-green-50"></div>

    <div id="leaderboard" class="card hidden"></div>

    <div class="graph-container">
      <canvas id="growthGraph" width="400" height="200"></canvas>
    </div>
  </div>
</div>

<script>
const API_URL = "http://127.0.0.1:8000";
const districtSeasons = {
  "Araria":["Kharif","Rabi","Autumn"], "Arwal":["Kharif","Rabi"], "Aurangabad":["Kharif","Rabi"],
  "Banka":["Kharif","Rabi"], "Begusarai":["Kharif","Rabi","Summer"], "Bhagalpur":["Kharif","Rabi","Autumn"],
  "Bhojpur":["Kharif","Rabi"], "Buxar":["Kharif","Rabi"], "Darbhanga":["Kharif","Rabi"],
  "Gaya":["Kharif","Rabi"], "Gopalganj":["Kharif","Rabi"], "Jamui":["Kharif","Rabi"],
  "Jehanabad":["Kharif","Rabi"], "Kaimur":["Kharif","Rabi"], "Katihar":["Kharif","Rabi","Autumn"],
  "Khagaria":["Kharif","Rabi"], "Kishanganj":["Kharif","Rabi","Autumn"], "Lakhisarai":["Kharif","Rabi"],
  "Madhepura":["Kharif","Rabi"], "Madhubani":["Kharif","Rabi"], "Munger":["Kharif","Rabi"],
  "Muzaffarpur":["Kharif","Rabi"], "Nalanda":["Kharif","Rabi"], "Nawada":["Kharif","Rabi"],
  "Patna":["Kharif","Rabi"], "Purnia":["Kharif","Rabi","Autumn"], "Rohtas":["Kharif","Rabi"],
  "Saharsa":["Kharif","Rabi"], "Samastipur":["Kharif","Rabi"], "Saran":["Kharif","Rabi"],
  "Sheikhpura":["Kharif","Rabi"], "Sheohar":["Kharif","Rabi"], "Sitamarhi":["Kharif","Rabi"],
  "Siwan":["Kharif","Rabi"], "Supaul":["Kharif","Rabi"], "Vaishali":["Kharif","Rabi"]
};
const districts = Object.keys(districtSeasons);
const panchayats = ["Panchayat A","Panchayat B","Panchayat C","Panchayat D"];

const steps = [
  {title:"üìç Location & Season", description:"Select your district, season, and panchayat.", input:[]},
  {title:"üß™ Personalization", description:"Do you want to enter soil/weather data?", input:[{label:"Use personalized data?", type:"select", id:"personalize", options:["No","Yes"]}]},
  {title:"üå± Field Conditions", description:"Enter soil and weather values.", input:[
    {label:"Soil pH", type:"range", id:"Soil_pH", min:4, max:9, step:0.1, tooltip:"Optimal 5.5-7.0"},
    {label:"Organic Carbon (%)", type:"range", id:"Organic_Carbon", min:0, max:10, step:0.1},
    {label:"Nitrogen (kg/ha)", type:"range", id:"Nitrogen", min:0, max:200, step:1},
    {label:"Phosphorus (kg/ha)", type:"range", id:"Phosphorus", min:0, max:100, step:1},
    {label:"Potassium (kg/ha)", type:"range", id:"Potassium", min:0, max:150, step:1},
    {label:"Total Rainfall (mm)", type:"range", id:"total_rainfall", min:0, max:2000, step:10},
    {label:"Avg Temperature (¬∞C)", type:"range", id:"avg_temp", min:10, max:45, step:0.5},
    {label:"Humidity (%)", type:"range", id:"Humidity", min:10, max:100, step:1}
  ], condition:()=>responses.personalize==="Yes"},
  {title:"1Ô∏è‚É£ Soil Preparation", description:"Soil preparation improves root growth and nutrient uptake.", input:[{label:"Method", type:"select", id:"soilPrep", options:["Tractor Tillage","Manual Tillage","Zero Till"]}]},
  {title:"2Ô∏è‚É£ Seed Selection", description:"Proper variety & sowing density affects yield.", input:[
    {label:"Variety", type:"select", id:"variety", options:["Shweta 1121","Samriddhi 6444","Basmati 1509"]},
    {label:"Sowing Density (kg/ha)", type:"number", id:"sowingDensity"}
  ]},
  {title:"3Ô∏è‚É£ Irrigation", description:"Irrigation ensures proper water supply.", input:[{label:"Irrigation method", type:"select", id:"irrigation", options:["Flood","Drip","SRI"]}]},
  {title:"4Ô∏è‚É£ Fertilizer Usage", description:"Proper fertilizer improves growth and grain quality.", input:[{label:"Fertilizer (kg/ha)", type:"number", id:"fertilizer"}]},
  {title:"5Ô∏è‚É£ Pest Control", description:"Pests damage yield. Timely pesticide use is recommended.", input:[{label:"Pesticide (kg/ha)", type:"number", id:"pesticide"}]},
  {title:"6Ô∏è‚É£ Weed Management", description:"Weeds compete with rice for nutrients.", input:[{label:"Weed Control Method", type:"select", id:"weedControl", options:["Manual","Herbicide","None"]}]},
  {title:"7Ô∏è‚É£ Mid Growth Observations", description:"Observe growth, height, and leaf color.", input:[
    {label:"Plant Height (cm)", type:"number", id:"plantHeight"},
    {label:"Leaf Color Index (1-10)", type:"number", id:"leafColor"}
  ]},
  {title:"8Ô∏è‚É£ Disease Management", description:"Monitor crop for diseases and act timely.", input:[
    {label:"Disease Observed?", type:"select", id:"diseaseObserved", options:["No","Yes"]},
    {label:"Action Taken", type:"select", id:"diseaseAction", options:["None","Pesticide","Other"]}
  ]},
  {title:"9Ô∏è‚É£ Weather Response", description:"Adjust irrigation or protection based on weather.", input:[
    {label:"Weather Issue", type:"select", id:"weatherIssue", options:["None","Excess Rain","Drought"]},
    {label:"Action Taken", type:"select", id:"weatherAction", options:["None","Irrigation Adjusted","Protected"]}
  ]},
  {title:"üîü Harvest", description:"Harvest timing and method affect yield quality.", input:[
    {label:"Actual yield (kg/ha)", type:"number", id:"userYield"},
    {label:"Harvest Method", type:"select", id:"harvestMethod", options:["Manual","Machine"]}
  ]}
];

const responses = {};
let currentStep = 0;
const container = document.getElementById("taskContainer");
const progressBar = document.getElementById("progressBar");

let growthChart = null;
function initChart(){
  const ctx = document.getElementById('growthGraph').getContext('2d');
  growthChart = new Chart(ctx, {
    type: 'line',
    data: { labels: [], datasets: [{label:'Growth Progress', data:[], borderColor:'#065f46', fill:false, tension:0.3}] },
    options: { responsive:true, plugins:{legend:{display:true}} }
  });
}
function updateChart(stepLabel, value){
  growthChart.data.labels.push(stepLabel);
  growthChart.data.datasets[0].data.push(value);
  growthChart.update();
}

function calculateScores(){
  let decisionScore = 0;
  let yieldScore = 0;

  if(responses.soilPrep==="Tractor Tillage") decisionScore+=10;
  else if(responses.soilPrep==="Manual Tillage") decisionScore+=7;
  else if(responses.soilPrep==="Zero Till") decisionScore+=4;

  if(responses.variety==="Basmati 1509") decisionScore+=10;
  else if(responses.variety) decisionScore+=7;

  if(responses.irrigation==="Flood") decisionScore+=15;
  else if(responses.irrigation==="Drip") decisionScore+=10;
  else if(responses.irrigation) decisionScore+=8;

  if(responses.fertilizer>=100 && responses.fertilizer<=150) decisionScore+=10;
  else if(responses.fertilizer>0) decisionScore+=5;

  if(responses.pesticide>0) decisionScore+=5;
  if(responses.weedControl && responses.weedControl!=="None") decisionScore+=5;
  if(responses.diseaseObserved==="No") decisionScore+=5;
  else if(responses.diseaseAction && responses.diseaseAction!=="None") decisionScore+=3;
  if(responses.weatherAction && responses.weatherAction!=="None") decisionScore+=5;

  if(responses.userYield){
    let y = Math.min(Math.max(responses.userYield,2000),3000);
    yieldScore = ((y-2000)/1000)*50;
  }

  decisionScore=Math.min(decisionScore,50);
  yieldScore=Math.min(yieldScore,50);

  return {decisionScore, yieldScore, totalScore:decisionScore+yieldScore};
}

function updateSidebar(){
  document.getElementById('sidebarStep').textContent = `Step: ${steps[currentStep]?.title || 'Completed'}`;
  const scores = calculateScores();
  document.getElementById('sidebarDecision').textContent = `Decision Score: ${scores.decisionScore.toFixed(1)}`;
  document.getElementById('sidebarYield').textContent = `Yield Score: ${scores.yieldScore.toFixed(1)}`;
  const step = steps[currentStep];
  document.getElementById('sidebarHint').textContent = step ? step.description : "Season completed! See your report card below.";
}

function renderStep(){
  container.innerHTML='';
  const step = steps[currentStep];
  if(step.condition && !step.condition()){ currentStep++; renderStep(); return; }

  const title = document.createElement('h2'); title.className='text-xl font-bold mb-2'; title.textContent=step.title;
  container.appendChild(title);
  const desc = document.createElement('p'); desc.className='mb-4 text-gray-700'; desc.textContent=step.description;
  container.appendChild(desc);

  if(step.title==="üìç Location & Season"){
    const label = document.createElement('label'); label.className='block font-semibold mb-1'; label.textContent='District';
    container.appendChild(label);
    const select = document.createElement('select'); select.id='district'; select.className='w-full p-2 mb-3 border rounded';
    select.innerHTML=districts.map(d=>`<option value="${d}">${d}</option>`).join('');
    container.appendChild(select);

    const seasonLabel = document.createElement('label'); seasonLabel.className='block font-semibold mb-1'; seasonLabel.textContent='Season';
    container.appendChild(seasonLabel);
    const seasonSelect = document.createElement('select'); seasonSelect.id='season'; seasonSelect.className='w-full p-2 mb-3 border rounded';
    seasonSelect.innerHTML=(districtSeasons[districts[0]]||["Kharif","Rabi","Autumn"]).map(s=>`<option value="${s}">${s}</option>`).join('');
    container.appendChild(seasonSelect);

    const panchayatLabel = document.createElement('label'); panchayatLabel.className='block font-semibold mb-1'; panchayatLabel.textContent='Panchayat';
    container.appendChild(panchayatLabel);
    const panchayatSelect = document.createElement('select'); panchayatSelect.id='panchayat'; panchayatSelect.className='w-full p-2 mb-3 border rounded';
    panchayatSelect.innerHTML=panchayats.map(p=>`<option value="${p}">${p}</option>`).join('');
    container.appendChild(panchayatSelect);
  }

  step.input.forEach(field=>{
    if(step.title==="üìç Location & Season") return;
    const label=document.createElement('label'); label.className='block font-semibold mb-1';
    label.innerHTML=field.tooltip?`${field.label} <span class='tooltip' data-tip='${field.tooltip}'>‚ÑπÔ∏è</span>`:field.label;
    container.appendChild(label);

    const input=field.type==='select'?document.createElement('select'):document.createElement('input');
    input.id=field.id; input.className='w-full p-2 mb-3 border rounded';
    if(field.type==='select') input.innerHTML=(field.options||[]).map(o=>`<option value="${o}">${o}</option>`).join('');
    else{ input.type=field.type; if(field.min) input.min=field.min; if(field.max) input.max=field.max; if(field.step) input.step=field.step; }
    container.appendChild(input);
  });

  const btn = document.createElement('button'); btn.textContent=currentStep===steps.length-1?'Submit':'Next';
  btn.className='btn bg-green-700 text-white py-2 px-5 rounded hover:bg-green-800 mt-3';
  btn.onclick=nextStep; container.appendChild(btn);

  progressBar.style.width=`${(currentStep/steps.length)*100}%`;
  updateSidebar();
}

async function nextStep(){
  const step=steps[currentStep];
  step.input?.forEach(f=>{
    const el=document.getElementById(f.id);
    if(el) responses[f.id]=(f.type==='number'||f.type==='range')?parseFloat(el.value):el.value;
  });

  if(step.title==="üìç Location & Season"){
    responses.district=document.getElementById('district').value;
    responses.season=document.getElementById('season').value;
    responses.panchayat=document.getElementById('panchayat').value;
  }

  let growthVal=0;
  switch(step.title){
    case "1Ô∏è‚É£ Soil Preparation": growthVal=10; break;
    case "2Ô∏è‚É£ Seed Selection": growthVal=10; break;
    case "3Ô∏è‚É£ Irrigation": growthVal=responses.irrigation?15:5; break;
    case "4Ô∏è‚É£ Fertilizer Usage": growthVal=responses.fertilizer?10:5; break;
    case "5Ô∏è‚É£ Pest Control": growthVal=responses.pesticide?5:0; break;
    case "6Ô∏è‚É£ Weed Management": growthVal=responses.weedControl?5:0; break;
    case "7Ô∏è‚É£ Mid Growth Observations": growthVal=(responses.plantHeight||0)/10; break;
    case "8Ô∏è‚É£ Disease Management": growthVal=(responses.diseaseObserved==="No")?5:0; break;
    case "9Ô∏è‚É£ Weather Response": growthVal=(responses.weatherAction!=="None")?5:0; break;
    case "üîü Harvest": growthVal=(responses.userYield||0)/1000; break;
    default: growthVal=0;
  }
  updateChart(step.title,growthVal);

  currentStep++; if(currentStep<steps.length) renderStep(); else await submitData();
}

async function submitData(){
  container.style.display='none';
  const payload={...responses};
  let predicted=0;
  try{ const res=await fetch(`${API_URL}/predict`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)}); const data=await res.json(); predicted=data.predicted_yield;}catch(e){console.warn(e);}

  const scores=calculateScores();
  const report=document.getElementById('reportCard'); report.style.display='block';
  report.innerHTML=`<h2 class="text-2xl font-bold mb-3">üéì Your Report Card</h2>
    <p>üß† Decision Score: ${scores.decisionScore.toFixed(1)} / 50</p>
    <p>üåæ Yield Score: ${scores.yieldScore.toFixed(1)} / 50</p>
    <p>üèÜ Total Score: ${scores.totalScore.toFixed(1)} / 100</p>
    <p>üìà Predicted Yield: ${predicted?.toFixed(2)||'N/A'} kg/ha</p>
    <p>üìç District: ${responses.district}, Panchayat: ${responses.panchayat}, Season: ${responses.season}</p>`;

  updateLeaderboard('Player', scores.totalScore);
  updateSidebar();
}

function updateLeaderboard(userName, score){
  const lb=JSON.parse(localStorage.getItem('leaderboard')||'[]');
  lb.push({name:userName, score}); lb.sort((a,b)=>b.score-b.score); localStorage.setItem('leaderboard', JSON.stringify(lb.slice(0,5)));
  const list=document.getElementById('leaderboardList'); 
  if(list) list.innerHTML=lb.slice(0,5).map(u=>`<li>${u.name}: ${u.score.toFixed(1)}</li>`).join('');
  document.getElementById('leaderboard').style.display='block';
}

window.onload=()=>{
  initChart();
  renderStep();
};
</script>
</body>
</html>
