<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Farmer Profile</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Arial', sans-serif;
  background: linear-gradient(to bottom right, #a5d956, #4da2ca);
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  flex-direction: column;
}

.profile-container {
  width: 80%;
  max-width: 1200px;
  background: #43877b;
  border-radius: 15px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  padding: 30px;
  display: flex;
  gap: 30px;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.profile-container:hover {
  transform: scale(1.02);
  box-shadow: 0 6px 12px rgba(0,0,0,0.2);
}

.profile-header {
  display: flex;
  flex-direction: column;
  gap: 20px;
  margin-bottom: 30px;
  flex: 1;
}

.user-photo img {
  width: 150px;
  height: 150px;
  object-fit: cover;
  border-radius: 10px; /* square with slightly rounded corners */
  border: 3px solid #ddd;
  transition: transform 0.3s ease;
}
.user-photo img:hover { transform: scale(1.05); }

.user-details {
  display: flex;
  flex-direction: column;
  justify-content: center;
  color: #fffafa;
}

.user-name { font-size: 3rem; font-weight: bold; color: #4d2727; }
.user-location, .user-crop, .user-age, .user-designation, .user-level, .reward-points, .total-badges {
  font-size: 2rem; margin: 5px 0;
}

.user-level { font-weight: bold; color: #FFC107; }
.reward-points { font-weight: bold; color: #00BCD4; }
.total-badges { font-weight: bold; color: #FF9800; }

.chart-container {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  flex: 1;
  max-width: 500px;
  height: 350px;
  border-radius: 10px;
  padding: 20px;
  background-color: #f7f7f7;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.chart-container p { margin-top: 20px; font-size: 25px; color: rgb(90,64,31); }

#generateCard {
  padding: 12px 25px;
  background-color: #4CAF50;
  color: white;
  font-size: 18px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  margin-top: 20px;
  width: 500px;
}
#generateCard:hover { background-color: #45a049; }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<div class="profile-container">
  <div class="profile-header">
    <div class="user-photo">
      <img id="profilePhoto" src="vartika.jpg" alt="User Photo">
    </div>
    <div class="user-details">
      <h2 class="user-name" id="userName">MR. RAM SINGH</h2>
      <p class="user-location" id="userLocation">Location: Salempur, UP</p>
      <p class="user-crop">Primary Crop: Corn</p>
      <p class="user-age">Age: 24</p>
      <p class="user-designation" id="userDesignation">Designation: Farmer</p>
      <p class="user-level" id="userLevel">Level: Beginner⭐</p>
      <p class="reward-points" id="rewardPoints">Total Points: 0</p>
      <p class="total-badges" id="totalBadges">Total Badges: 0</p>
      <button id="generateCard">Generate Card PDF</button>
    </div>
  </div>

  <div class="chart-container">
    <canvas id="farmerChart"></canvas>
    <p>PROGRESS REPORT</p>
  </div>
</div>


<script>
const nameEl = document.getElementById('userName');
const locationEl = document.getElementById('userLocation');
const rewardPointsEl = document.getElementById('rewardPoints');
const totalBadgesEl = document.getElementById('totalBadges');
const designationEl = document.getElementById('userDesignation');
const levelEl = document.getElementById('userLevel');
const photoEl = document.getElementById('profilePhoto');
const token = localStorage.getItem('token');

let farmerChart = null;

// Load user data
async function loadAll() {
  try {
    const userRes = await fetch('/api/user', {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    if (!userRes.ok) return window.location.href = '/';
    const user = await userRes.json();

    const Wheat = user.pointsWheat ?? 0;
    const Rice  = user.pointsRice ?? 0;
    const Corn  = user.pointsCorn ?? 0;
    const Bajra = user.pointsBajra ?? 0;
    const totalPoints = Wheat + Rice + Corn + Bajra;

    nameEl.innerText = user.name;
    locationEl.innerText = `Location: ${user.location}`;
    rewardPointsEl.innerText = `Total Points: ${totalPoints}`;
    photoEl.src = `${user.phoneNo}.jpg`;

    const totalBadges = Math.floor(totalPoints / 100);
    totalBadgesEl.innerText = `Total Badges: ${totalBadges}`;

    if(totalPoints > 200 && totalPoints < 400) designationEl.innerText = 'Designation: Intermediate Farmer';
    else if(totalPoints >= 400) designationEl.innerText = 'Designation: Master Farmer';
    else designationEl.innerText = 'Designation: Farmer';

    if(totalPoints <= 200) { levelEl.innerText = 'Level: Beginner⭐'; levelEl.style.color = '#FFC107'; }
    else if(totalPoints > 200 && totalPoints < 400) { levelEl.innerText = 'Level: Intermediate⭐⭐'; levelEl.style.color = '#FF9800'; }
    else if(totalPoints >= 400 && totalPoints < 500) { levelEl.innerText = 'Level: Advanced⭐⭐⭐'; levelEl.style.color = '#00BCD4'; }
    else if(totalPoints >= 500) { levelEl.innerText = 'Level: Master'; levelEl.style.color = '#4CAF50'; }

    if (farmerChart) farmerChart.destroy();
    farmerChart = new Chart(document.getElementById('farmerChart').getContext('2d'), {
      type: 'bar',
      data: {
        labels: ['Wheat', 'Corn', 'Bajra', 'Rice'],
        datasets: [{
          label: 'Harvest Points',
          data: [Wheat, Corn, Bajra, Rice],
          backgroundColor: '#4CAF50',
          borderColor: '#4CAF50',
          borderWidth: 1
        }]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

  } catch (err) { console.error(err); alert('Failed to load dashboard.'); }
}
loadAll();

// PDF Generator
document.getElementById('generateCard').addEventListener('click', async () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'px', format: [400, 600] });

  function loadImage(url) {
    return new Promise((resolve,reject)=>{
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.src = url;
      img.onload = ()=>resolve(img);
      img.onerror = e=>reject(e);
    });
  }

  try {
    // Company logo watermark
    const bgImg = await loadImage('Screenshot_2025-08-29_092552-removebg-preview.png'); // replace with your logo
    doc.setGState(new doc.GState({ opacity: 0.10 }));
    doc.addImage(bgImg, 'PNG', 0, 0, 400, 600);
    doc.setGState(new doc.GState({ opacity: 1 }));

    // Profile photo square top center
    const profileImg = await loadImage(photoEl.src);
    const imgSize = 120;
    doc.addImage(profileImg, 'JPEG', 140, 20, imgSize, imgSize);

    // Texts below photo
    doc.setFont('helvetica','bold'); doc.setFontSize(18); doc.setTextColor(33,33,33);
    doc.text(nameEl.innerText, 200, 160, { align: 'center' });

    doc.setFont('helvetica','normal'); doc.setFontSize(14); doc.setTextColor(50,50,50);
    doc.text(locationEl.innerText.replace('Location: ',''), 200, 185, { align: 'center' });
    doc.text(designationEl.innerText, 200, 210, { align: 'center' });

    doc.setTextColor(levelEl.style.color || '#000000');
    doc.text(levelEl.innerText, 200, 235, { align: 'center' });

    doc.setTextColor(33,33,33);
    doc.text(rewardPointsEl.innerText, 200, 260, { align: 'center' });
    doc.text(totalBadgesEl.innerText, 200, 285, { align: 'center' });

    // Badges
    const badgeCount = parseInt(totalBadgesEl.innerText.replace('Total Badges: ',''));
    let badgesText = '';
    for(let i=0;i<badgeCount;i++){ badgesText += ' '; }
    doc.setFontSize(20);
    doc.text(badgesText.trim(), 200, 315, { align: 'center' });

    doc.setFontSize(12); doc.setTextColor(120,120,120);
    doc.text('Sustainable Farming Rewards', 200, 580, { align: 'center' });

    doc.save(`${nameEl.innerText.replace(' ','_')}_ProfileCard.pdf`);
  } catch(err){
    console.error(err);
    alert('Failed to generate PDF. Check image URLs.');
  }
});
</script>

</body>
</html>
